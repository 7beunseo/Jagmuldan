<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    {% for photo in product.product_image.all %}
                <img src="{{photo.image.url}}" width="50"><br>
            {% endfor %}
    생산지-{{product.origin}}<br>
    재배 특징 - {{product.production_features}}<br>
    생산자-{{ product.seller.user.username }}<br>

    (생산자 프로필)<img src="{{product.seller.image.url}}" width="50"><br>
    한줄소개 - {{ product.seller.description }}<br><br><br>
    좋아요 수 : <span id="like-count">{{product.like_product.count}}</span>
    {% if product in request.user.like_product.all %}
        <a href="#" class="like-btn" data-product-id="{{ product.id }}">찜 취소</a>
    {% else %}
        <a href="#" class="like-btn" data-product-id="{{ product.id }}">찜하기</a>
    {% endif %}<br><br>
    가격 - {{product.price}}원<br>
    할인 적용된 가격 - {{ discount_price }}원<br>
    할인률 - {{ product.discount_rate }}%
    <form action="" method="post">
        {% csrf_token %}
        <input type="number" name="quantity" min="1" required> <!-- quantity 값을 입력받는 input 요소 -->
        <button type="submit" name="action" value="goto_basket" id="basket-button">장바구니에 추가</button>
        <button type="submit" name="action" value="purchase" id="order-button">주문하기</button>
    </form>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () { //페이지가 완전히 로드된 후에 실행되는 JavaScript코드 블록 정의 
            $(".like-btn").on("click", function (event) { // 클래스가 like-btn 인 모든 요소에 대해 클릭 이벤트 처리 -> 좋아요 버튼들에 대한 클릭 이벤트를 처리하도록 함 
                event.preventDefault();  // 클릭 이벤트의 기본 동작 취소, 좋아요 버튼 클릭 시 페이지의 이동을 막기 위함 
                var productId = $(this).data("product-id"); //클릭한 좋아요 버튼의 data-product-id 속성을 가져와서 productId 변수에 저장
                var likeCountElement = $("#like-count"); // 좋아요 수를 표시하는 HTML 요소(id)를 가져와서 likeCountElement 변수에 저장
    
                $.ajax({  // Ajax 요청을 수행하는 코드 블록
                    url: "{% url 'add_remove_whishlist' %}",  // Ajax 요청의 URL을 "/add_remove_whishlist/"로 설정
                    type: "POST",
                    data: {
                        product_id: productId,  // product_id와 csrfmiddlewaretoken을 함께 서버로 전송
                        csrfmiddlewaretoken: "{{ csrf_token }}",
                    },
                    success: function (response) {  // Ajax 요청이 성공적으로 완료된 경우 실행되는 함수입니다. 서버에서 받은 응답을 처리
                        // 좋아요 버튼 상태 업데이트
                        if (response.liked) {  // response 객체의 liked 속성을 확인하여, 좋아요 상태를 업데이트
                            $(".like-btn[data-product-id=" + productId + "]").text("찜 취소");
                            likeCountElement.text(parseInt(likeCountElement.text()) + 1);
                        } else {
                            $(".like-btn[data-product-id=" + productId + "]").text("찜하기");
                            likeCountElement.text(parseInt(likeCountElement.text()) - 1);
                        }
                    },
                    error: function () {  // Ajax 요청이 실패한 경우 실행되는 함수
                        alert("에러가 발생했습니다.");
                    },
                });
            });
        });
    </script>
    
    </body>
    </html>